<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploaded Files</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        :root {
            --body-bg: #f4f4f4;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --table-bg: #ffffff;
            --table-striped-bg: #f8f9fa;
            --table-hover-bg: #e9ecef;
            --table-border-color: #dee2e6;
            --table-text-color: #212529;
            --link-color: #007bff;
            --link-hover-color: #0056b3;
            --btn-primary-bg: #007bff;
            --btn-primary-border: #007bff;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #6c757d;
            --btn-secondary-border: #6c757d;
            --btn-secondary-text: #ffffff; /* White */
            --btn-info-bg: #17a2b8;
            --btn-info-border: #17a2b8;
            --btn-info-text: #ffffff; /* White */
            --btn-danger-bg: #dc3545;
            --btn-danger-border: #dc3545;
            --btn-danger-text: #ffffff;
            --input-bg: #fff;
            --input-border: #ced4da;
            --input-text: #495057;

            --theme-toggle-bg: #4CAF50;
            --theme-toggle-text: white;
            --theme-toggle-hover-bg: #45a049;
        }

        body.dark-mode {
            --body-bg: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2c2c2c;
            --border-color: #444444;
            --table-bg: #2c2c2c;
            --table-striped-bg: #383838;
            --table-hover-bg: #454545;
            --table-border-color: #555555;
            --table-text-color: #e0e0e0;
            --link-color: #6ea8fe;
            --link-hover-color: #90bfff;
            --btn-primary-bg: #0d6efd;
            --btn-primary-border: #0d6efd;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #5a6268;
            --btn-secondary-border: #545b62;
            --btn-secondary-text: #ffffff; /* White */
            --btn-info-bg: #39acbe;
            --btn-info-border: #39acbe;
            --btn-info-text: #ffffff; /* White */
            --btn-danger-bg: #e44d5a;
            --btn-danger-border: #e44d5a;
            --btn-danger-text: #ffffff;
            --input-bg: #333;
            --input-border: #555;
            --input-text: #e0e0e0;

            --theme-toggle-bg: #5a6678;
            --theme-toggle-text: #f0f0f0;
            --theme-toggle-hover-bg: #434c59;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            padding: 20px;
            position: relative;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: 70px;
        }

        .back-button {
            position: fixed; top: 15px; left: 15px; z-index: 1001;
        }

        .theme-toggle-btn {
            position: fixed; top: 15px; right: 15px; background-color: var(--theme-toggle-bg); color: var(--theme-toggle-text); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; z-index: 1000; display: flex; justify-content: center; align-items: center; outline: none; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .theme-toggle-btn:hover { background-color: var(--theme-toggle-hover-bg); }

        .container-custom {
            padding-bottom: 20px; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .container-custom { box-shadow: 0 0 15px rgba(255,255,255,0.05); }

        .table-responsive-custom {
            display: block; width: 100%;
            /* overflow-x: auto; We aim to avoid this, but it's a fallback if content is still too wide */
            -webkit-overflow-scrolling: touch;
        }

        .table {
            background-color: var(--table-bg); color: var(--table-text-color); border-color: var(--table-border-color); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            table-layout: fixed; /* Helps distribute width more predictably */
            width: 100%; /* Ensure table tries to use full container width */
        }
        .table th, .table td {
            border-color: var(--table-border-color); color: var(--table-text-color);
            word-wrap: break-word; /* Fallback for overflow-wrap */
            overflow-wrap: break-word; /* Allow long words to break and wrap */
            white-space: normal; /* Ensure text wraps */
        }
        .table-striped tbody tr:nth-of-type(odd) { background-color: var(--table-striped-bg); }
        .table-hover tbody tr:hover { background-color: var(--table-hover-bg); color: var(--table-text-color); }

        .table a { color: var(--link-color); }
        .table a:hover { color: var(--link-hover-color); }

        .btn-primary { background-color: var(--btn-primary-bg); border-color: var(--btn-primary-border); color: var(--btn-primary-text); }
        .btn-secondary { background-color: var(--btn-secondary-bg); border-color: var(--btn-secondary-border); color: var(--btn-secondary-text); }
        .btn-info { background-color: var(--btn-info-bg); border-color: var(--btn-info-border); color: var(--btn-info-text); }
        .btn-danger { background-color: var(--btn-danger-bg); border-color: var(--btn-danger-border); color: var(--btn-danger-text); }

        .table td a.btn-info { color: var(--btn-info-text) !important; }
        .table td a.btn-secondary { color: var(--btn-secondary-text) !important; }

        body.dark-mode .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; color: var(--btn-primary-text); }
        body.dark-mode .btn-secondary:hover { background-color: #494f54; border-color: #43484d; color: var(--btn-secondary-text); }
        body.dark-mode .btn-info:hover { background-color: #2d8ea0; border-color: #2a8293; color: var(--btn-info-text); }
        body.dark-mode .btn-danger:hover { background-color: #c43e4a; border-color: #b83a44; color: var(--btn-danger-text); }

        .btn-primary:hover, .btn-secondary:hover, .btn-info:hover, .btn-danger:hover {
             /* Ensuring text color is maintained on hover for light mode too, if variables are set */
            color: var(--btn-primary-text); /* This needs to be specific per button type if text color varies */
        }
        /* More specific hover text color for light mode: */
        .btn-secondary:hover { color: var(--btn-secondary-text); }
        .btn-info:hover { color: var(--btn-info-text); }


        body.dark-mode input[type="checkbox"] { filter: invert(85%) hue-rotate(180deg); }
        body.dark-mode input[type="checkbox"]:checked { filter: invert(60%) hue-rotate(180deg) brightness(1.2); }

        h2 { color: var(--text-color); transition: color 0.3s ease; }

        @media (min-width: 768px) {
            body { padding: 50px; padding-top: 70px; }
            .back-button { top: 20px; left: 20px; }
            .theme-toggle-btn { top: 20px; right: 20px; }
        }

        /* === MODIFICATIONS FOR SMALL SCREENS TO FIT CONTENT === */
        @media (max-width: 576px) {
            .table th, .table td {
                padding: 0.4rem 0.2rem; /* Reduced padding significantly (top/bottom LR) */
                font-size: 0.75rem; /* Slightly smaller font */
            }

            /* Checkbox column can be narrower */
            #multiDeleteForm .table thead th:first-child,
            #multiDeleteForm .table tbody td:first-child {
                width: 30px; /* Narrower checkbox column */
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }
             #multiDeleteForm .table thead th:first-child input[type="checkbox"] {
                transform: scale(0.9); /* Make checkbox slightly smaller */
            }
            #multiDeleteForm .table tbody td:first-child input[type="checkbox"] {
                transform: scale(0.9);
            }


            /* Filename column: allow it to break aggressively */
            .table td:nth-child(2), .table th:nth-child(2) { /* Filename column */
                word-break: break-all; /* Force break for long unbroken strings */
                 /* Consider a max-width or allow it to take remaining space */
            }

            /* Columns with buttons: remove min-width, let them shrink */
            .table th:nth-child(3), .table td:nth-child(3), /* VirusTotal Report */
            .table th:nth-child(4), .table td:nth-child(4),  /* Email Header */
            .table th:nth-child(5), .table td:nth-child(5) { /* Action */
                min-width: auto; /* Remove minimum width constraint */
            }

            .table td .btn {
                display: block; /* Buttons stack vertically within their cell */
                width: 100%;
                margin-bottom: 3px; /* Reduced margin */
                white-space: normal; /* Crucial: Allow text in buttons to wrap */
                line-height: 1.2;    /* Adjust line height for wrapped text */
                font-size: 0.7rem;   /* Smaller font for buttons */
                padding: 0.2rem 0.1rem; /* Smaller padding for buttons */
            }
            .table td .btn:last-child {
                margin-bottom: 0;
            }
        }
        /* Further adjustments for very narrow screens if necessary */
        @media (max-width: 380px) {
             .table th, .table td {
                padding: 0.3rem 0.1rem;
                font-size: 0.7rem;
            }
            #multiDeleteForm .table thead th:first-child,
            #multiDeleteForm .table tbody td:first-child {
                width: 25px;
            }
            .table td .btn {
                font-size: 0.65rem;
                padding: 0.15rem 0.1rem;
            }
        }


        #multiDeleteForm .table thead th:first-child,
        #multiDeleteForm .table tbody td:first-child {
            width: 50px; text-align: center; /* Default for larger screens */
        }
        #multiDeleteForm .table thead th { vertical-align: middle; }

    </style>
</head>
<body>
    <a href="/" class="btn btn-primary back-button">
        <span class="fas fa-arrow-left"></span> Back
    </a>
    <button id="theme-toggle" class="theme-toggle-btn">ðŸŒ“</button>

    <div class="container container-custom">
        <h2 class="text-center mb-4">Uploaded Files</h2>
        {% if files %}
        <form id="multiDeleteForm">
            <div class="table-responsive-custom mb-3">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" title="Select all files"></th>
                            <th>Filename</th>
                            <th>VirusTotal Report</th>
                            <th>Email Header</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                        <tr>
                            <td><input type="checkbox" class="file-checkbox" value="{{ file.filename }}" title="Select {{ file.filename }}"></td>
                            <td>{{ file.filename }}</td>
                            <td><a href="/report/{{ file.scan_id }}" class="btn btn-info btn-sm">View Report</a></td>
                            <td><a href="/header/{{ file.filename }}" class="btn btn-secondary btn-sm">View Header</a></td>
                            <td><button type="button" class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.filename }}">Delete</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-danger mt-2" id="deleteSelected">Delete Selected</button>
        </form>
        {% else %}
            <p class="text-center">No files uploaded yet.</p>
        {% endif %}
    </div>

    <script>
        $(document).ready(function() {
            const themeToggleBtn = $('#theme-toggle');
            const bodyElement = $('body');

            function applyTheme(theme) { // theme can be 'dark-mode' or 'light-mode'
                if (theme === 'dark-mode') {
                    bodyElement.addClass('dark-mode');
                    themeToggleBtn.text('â˜€ï¸'); // Sun icon for light mode
                } else {
                    bodyElement.removeClass('dark-mode');
                    themeToggleBtn.text('ðŸŒ“'); // Moon icon for dark mode
                }
                localStorage.setItem('theme', theme);
            }

            let preferredTheme = localStorage.getItem('theme');
            if (!preferredTheme) { // If no theme saved, check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    preferredTheme = 'dark-mode';
                } else {
                    preferredTheme = 'light-mode'; // Default to light
                }
            }
            applyTheme(preferredTheme);

            themeToggleBtn.on('click', () => {
                let newTheme = bodyElement.hasClass('dark-mode') ? 'light-mode' : 'dark-mode';
                applyTheme(newTheme);
            });

            // Existing script for delete functionality
            $(document).on('click', '.delete-btn', function() {
                const filename = $(this).data('filename');
                if (confirm(`Are you sure you want to delete ${filename}?`)) {
                    fetch(`/delete/${filename}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert('Failed to delete the file: ' + (data.message || 'Unknown error'));
                            }
                        })
                        .catch(() => alert('An error occurred while deleting the file.'));
                }
            });

            $('#selectAll').on('change', function() {
                const isChecked = this.checked;
                $('.file-checkbox').prop('checked', isChecked);
            });

            $('#deleteSelected').on('click', function() {
                const selectedFiles = $('.file-checkbox:checked').map(function() {
                    return this.value;
                }).get();

                if (selectedFiles.length === 0) {
                    alert('No files selected.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${selectedFiles.length} file(s)?`)) return;

                fetch('/delete-multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selectedFiles })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete selected files: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(() => alert('An error occurred while deleting selected files.'));
            });
        });
    </script>
</body>
</html>